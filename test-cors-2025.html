<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase 2025 CORS Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .test-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .success { color: green; }
    .error { color: red; }
    .warning { color: orange; }
    .log-container {
      background: #f5f5f5;
      border-radius: 4px;
      padding: 12px;
      max-height: 200px;
      overflow: auto;
      font-family: monospace;
      font-size: 14px;
    }
    button {
      background: #4a5568;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #2d3748;
    }
    h1 { color: #2d3748; }
    h2 { color: #4a5568; }
  </style>
</head>
<body>
  <h1>Supabase 2025 CORS Test</h1>
  <p>This page tests Supabase's 2025 CORS behavior with different request types.</p>
  
  <div class="test-card">
    <h2>Configuration</h2>
    <p>Enter your Supabase URL and anonymous key:</p>
    <div>
      <label for="supabase-url">Supabase URL:</label>
      <input type="text" id="supabase-url" value="https://qfkxftmzrfpskdtlolos.supabase.co" style="width: 300px;">
    </div>
    <div style="margin-top: 8px;">
      <label for="supabase-key">Anon Key:</label>
      <input type="text" id="supabase-key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFma3hmdG16cmZwc2tkdGxvbG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5Nzc4MTUsImV4cCI6MjA2NDU1MzgxNX0.oYw-bU8Vg4-NDaTubgxCY_8iOpBNvOh4l82XKCJrkDM" style="width: 300px;">
    </div>
  </div>
  
  <div class="test-card">
    <h2>Test 1: Simple Request (No Preflight)</h2>
    <p>This test makes a simple request using only standard headers.</p>
    <button id="run-test-1">Run Test</button>
    <div id="test-1-result" class="log-container" style="margin-top: 12px;"></div>
  </div>
  
  <div class="test-card">
    <h2>Test 2: Custom Headers Request (Triggers Preflight)</h2>
    <p>This test adds custom headers that will trigger a CORS preflight request.</p>
    <button id="run-test-2">Run Test</button>
    <div id="test-2-result" class="log-container" style="margin-top: 12px;"></div>
  </div>

  <div class="test-card">
    <h2>Results Summary</h2>
    <div id="results-summary">Run the tests to see results</div>
  </div>

  <script>
    // Utility to log to the test result containers
    function log(containerId, message, type = 'log') {
      const container = document.getElementById(containerId);
      const entry = document.createElement('div');
      entry.classList.add(type);
      entry.textContent = message;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    // Test 1: Simple request with standard headers
    document.getElementById('run-test-1').addEventListener('click', async () => {
      const resultContainer = 'test-1-result';
      const supabaseUrl = document.getElementById('supabase-url').value;
      const supabaseKey = document.getElementById('supabase-key').value;
      
      document.getElementById(resultContainer).innerHTML = '';
      log(resultContainer, 'Starting simple request test...');
      
      try {
        log(resultContainer, 'Making request with standard headers');
        log(resultContainer, `URL: ${supabaseUrl}/rest/v1/groups?select=id&limit=1`);
        
        const startTime = performance.now();
        const response = await fetch(`${supabaseUrl}/rest/v1/groups?select=id&limit=1`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseKey
          }
        });
        const endTime = performance.now();
        
        if (response.ok) {
          const data = await response.json();
          log(resultContainer, `Success! Response time: ${(endTime - startTime).toFixed(2)}ms`, 'success');
          log(resultContainer, `Response data: ${JSON.stringify(data)}`);
          
          // Check response headers for CORS
          log(resultContainer, 'CORS Headers received:');
          const corsHeaders = Array.from(response.headers.entries())
            .filter(([key]) => key.toLowerCase().startsWith('access-control'));
          
          if (corsHeaders.length === 0) {
            log(resultContainer, 'No CORS headers detected in response', 'warning');
          } else {
            corsHeaders.forEach(([key, value]) => {
              log(resultContainer, `${key}: ${value}`);
            });
          }
          
          updateSummary('test-1', true);
        } else {
          log(resultContainer, `Failed: ${response.status} ${response.statusText}`, 'error');
          log(resultContainer, await response.text(), 'error');
          updateSummary('test-1', false);
        }
      } catch (error) {
        log(resultContainer, `Error: ${error.message}`, 'error');
        updateSummary('test-1', false, error.message);
      }
    });

    // Test 2: Request with custom headers (triggers preflight)
    document.getElementById('run-test-2').addEventListener('click', async () => {
      const resultContainer = 'test-2-result';
      const supabaseUrl = document.getElementById('supabase-url').value;
      const supabaseKey = document.getElementById('supabase-key').value;
      
      document.getElementById(resultContainer).innerHTML = '';
      log(resultContainer, 'Starting custom headers request test...');
      
      try {
        log(resultContainer, 'Making request with custom headers');
        log(resultContainer, `URL: ${supabaseUrl}/rest/v1/groups?select=id&limit=1`);
        log(resultContainer, 'Headers include x-custom-header which triggers preflight');
        
        const startTime = performance.now();
        const response = await fetch(`${supabaseUrl}/rest/v1/groups?select=id&limit=1`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseKey,
            'x-custom-header': 'test',
            'x-github-pages-domain': window.location.hostname
          }
        });
        const endTime = performance.now();
        
        if (response.ok) {
          const data = await response.json();
          log(resultContainer, `Success! Response time: ${(endTime - startTime).toFixed(2)}ms`, 'success');
          log(resultContainer, `Response data: ${JSON.stringify(data)}`);
          
          // Check response headers for CORS
          log(resultContainer, 'CORS Headers received:');
          const corsHeaders = Array.from(response.headers.entries())
            .filter(([key]) => key.toLowerCase().startsWith('access-control'));
          
          if (corsHeaders.length === 0) {
            log(resultContainer, 'No CORS headers detected in response', 'warning');
          } else {
            corsHeaders.forEach(([key, value]) => {
              log(resultContainer, `${key}: ${value}`);
            });
          }
          
          updateSummary('test-2', true);
        } else {
          log(resultContainer, `Failed: ${response.status} ${response.statusText}`, 'error');
          log(resultContainer, await response.text(), 'error');
          updateSummary('test-2', false);
        }
      } catch (error) {
        log(resultContainer, `Error: ${error.message}`, 'error');
        updateSummary('test-2', false, error.message);
      }
    });

    // Update the summary section
    function updateSummary(testId, success, errorMessage = '') {
      const summary = document.getElementById('results-summary');
      
      if (testId === 'test-1') {
        window.test1Result = { success, errorMessage };
      } else if (testId === 'test-2') {
        window.test2Result = { success, errorMessage };
      }
      
      // Only update if both tests have been run
      if (window.test1Result && window.test2Result) {
        if (window.test1Result.success && !window.test2Result.success) {
          summary.innerHTML = `
            <p class="success">✅ Simple requests work correctly</p>
            <p class="error">❌ Custom header requests fail</p>
            <p><strong>Conclusion:</strong> This matches the 2025 Supabase CORS behavior. Supabase automatically handles basic CORS for simple requests, but custom headers trigger preflight requests that need special handling.</p>
            <p><strong>Recommendation:</strong> Avoid using custom headers in your requests to Supabase, or implement a proxy solution as described in the documentation.</p>
          `;
        } else if (window.test1Result.success && window.test2Result.success) {
          summary.innerHTML = `
            <p class="success">✅ Both simple and custom header requests work</p>
            <p><strong>Conclusion:</strong> Your Supabase project is properly configured to handle all CORS requests, including those with custom headers.</p>
          `;
        } else if (!window.test1Result.success && !window.test2Result.success) {
          summary.innerHTML = `
            <p class="error">❌ Both simple and custom header requests fail</p>
            <p><strong>Conclusion:</strong> There may be a more fundamental connection issue or RLS policy problem, not just CORS.</p>
            <p><strong>Error:</strong> ${window.test1Result.errorMessage}</p>
          `;
        } else {
          summary.innerHTML = `
            <p class="error">❌ Simple requests fail</p>
            <p class="success">✅ Custom header requests work</p>
            <p><strong>Conclusion:</strong> This is an unusual situation that may indicate custom CORS handling on your Supabase instance.</p>
          `;
        }
      }
    }
  </script>
</body>
</html>