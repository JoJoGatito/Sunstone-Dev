<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  
  <!-- Tailwind CSS via CDN for UI styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase Configuration -->
  <script src="../supabase-config.js"></script>
  
  <!-- Authentication Module -->
  <script src="./auth/auth.js"></script>
  
  <!-- Events Management Modules -->
  <script src="./events/event-list.js"></script>
  <script src="./events/event-form.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 border-r border-gray-700 hidden md:block">
      <div class="flex flex-col h-full">
        <!-- Logo/Header -->
        <div class="px-6 py-6 border-b border-gray-700">
          <h1 class="text-xl font-bold">Admin Dashboard</h1>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 px-4 py-4 overflow-y-auto">
          <div class="mb-6">
            <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
              General
            </h2>
            <div class="space-y-1">
              <a href="./index.html" class="flex items-center px-2 py-2 text-sm font-medium rounded-md bg-gray-700 text-white">
                <i class="fas fa-tachometer-alt mr-3 text-gray-300"></i>
                Dashboard
              </a>
            </div>
          </div>
          
          <div class="mb-6">
            <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
              Events Management
            </h2>
            <div class="space-y-1">
              <a href="#" id="nav-events" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                <i class="fas fa-calendar mr-3 text-gray-400"></i>
                View Events
              </a>
              <a href="#" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                <i class="fas fa-plus-circle mr-3 text-gray-400"></i>
                Add Event
              </a>
            </div>
          </div>
          
          <div class="mb-6">
            <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
              Configuration
            </h2>
            <div class="space-y-1">
              <a href="./setup-rls-policies.html" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                <i class="fas fa-shield-alt mr-3 text-gray-400"></i>
                Security Policies
              </a>
            </div>
          </div>
        </nav>
        
        <!-- User Info -->
        <div class="border-t border-gray-700 p-4">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center">
                <span id="sidebar-user-initials" class="text-sm font-medium text-white"></span>
              </div>
            </div>
            <div class="ml-3">
              <p id="sidebar-user-email" class="text-sm font-medium text-white"></p>
              <button id="sidebar-logout-button" class="text-xs text-gray-400 hover:text-gray-200">
                Sign out
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile sidebar toggle -->
    <div class="md:hidden fixed top-0 left-0 right-0 z-10 bg-gray-800 border-b border-gray-700 px-4 py-3">
      <div class="flex items-center justify-between">
        <h1 class="text-lg font-bold">Admin Dashboard</h1>
        <button id="mobile-menu-toggle" class="text-gray-300 hover:text-white">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
    
    <!-- Mobile sidebar -->
    <div id="mobile-sidebar" class="fixed inset-0 z-20 bg-gray-900 bg-opacity-50 md:hidden hidden">
      <div class="absolute inset-y-0 left-0 w-64 bg-gray-800 shadow-lg transform transition ease-in-out duration-300">
        <div class="flex flex-col h-full">
          <!-- Mobile Header -->
          <div class="px-6 py-6 border-b border-gray-700 flex items-center justify-between">
            <h1 class="text-xl font-bold">Admin Dashboard</h1>
            <button id="mobile-menu-close" class="text-gray-300 hover:text-white">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- Mobile Navigation -->
          <nav class="flex-1 px-4 py-4 overflow-y-auto">
            <div class="mb-6">
              <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                General
              </h2>
              <div class="space-y-1">
                <a href="./index.html" class="flex items-center px-2 py-2 text-sm font-medium rounded-md bg-gray-700 text-white">
                  <i class="fas fa-tachometer-alt mr-3 text-gray-300"></i>
                  Dashboard
                </a>
              </div>
            </div>
            
            <div class="mb-6">
              <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                Events Management
              </h2>
              <div class="space-y-1">
                <a href="#" id="mobile-nav-events" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                  <i class="fas fa-calendar mr-3 text-gray-400"></i>
                  View Events
                </a>
                <a href="#" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                  <i class="fas fa-plus-circle mr-3 text-gray-400"></i>
                  Add Event
                </a>
              </div>
            </div>
            
            <div class="mb-6">
              <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                Configuration
              </h2>
              <div class="space-y-1">
                <a href="./setup-rls-policies.html" class="flex items-center px-2 py-2 text-sm font-medium rounded-md text-gray-300 hover:bg-gray-700 hover:text-white">
                  <i class="fas fa-shield-alt mr-3 text-gray-400"></i>
                  Security Policies
                </a>
              </div>
            </div>
          </nav>
          
          <!-- Mobile User Info -->
          <div class="border-t border-gray-700 p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center">
                  <span id="mobile-user-initials" class="text-sm font-medium text-white"></span>
                </div>
              </div>
              <div class="ml-3">
                <p id="mobile-user-email" class="text-sm font-medium text-white"></p>
                <button id="mobile-logout-button" class="text-xs text-gray-400 hover:text-gray-200">
                  Sign out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Content Header -->
      <header class="bg-gray-800 border-b border-gray-700 md:py-6 md:px-8 px-4 py-16">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">Dashboard</h2>
          <div class="flex items-center space-x-4">
            <span class="bg-green-500 rounded-full w-2 h-2"></span>
            <span class="text-sm text-gray-300">Connected to Supabase</span>
          </div>
        </div>
      </header>
      
      <!-- Page Content -->
      <main class="flex-1 overflow-y-auto p-4 md:p-8">
        <div id="loading" class="flex flex-col items-center justify-center h-full">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
          <p class="mt-4 text-gray-400">Loading...</p>
        </div>
        
        <div id="content" class="hidden">
          <!-- Dashboard Content -->
          <div id="dashboard-view">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Event Stats Card -->
            <div class="bg-gray-800 rounded-lg p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Total Events</h3>
                <span class="text-blue-500"><i class="fas fa-calendar"></i></span>
              </div>
              <p id="total-events" class="text-3xl font-bold">--</p>
              <p class="text-gray-400 text-sm mt-2">Across all groups</p>
            </div>
            
            <!-- Groups Stats Card -->
            <div class="bg-gray-800 rounded-lg p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Active Groups</h3>
                <span class="text-purple-500"><i class="fas fa-users"></i></span>
              </div>
              <p id="total-groups" class="text-3xl font-bold">--</p>
              <p class="text-gray-400 text-sm mt-2">Publishing events</p>
            </div>
            
            <!-- Upcoming Events Card -->
            <div class="bg-gray-800 rounded-lg p-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-medium">Upcoming Events</h3>
                <span class="text-green-500"><i class="fas fa-calendar-day"></i></span>
              </div>
              <p id="upcoming-events" class="text-3xl font-bold">--</p>
              <p class="text-gray-400 text-sm mt-2">In the next 30 days</p>
            </div>
          </div>
          
          <!-- Recent Events Section -->
          <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold">Recent Events</h3>
              <a href="#" class="text-blue-400 hover:text-blue-300 text-sm">View all</a>
            </div>
            
            <div class="bg-gray-800 rounded-lg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                  <thead class="bg-gray-700">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Event Name</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Group</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="recent-events-table" class="bg-gray-800 divide-y divide-gray-700">
                    <tr class="animate-pulse">
                      <td colspan="5" class="px-6 py-4 text-center text-gray-400">Loading events...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Security Status Section -->
          <div>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold">Security Status</h3>
              <a href="./setup-rls-policies.html" class="text-blue-400 hover:text-blue-300 text-sm">Manage</a>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-6">
              <div class="mb-6">
                <h4 class="text-lg font-medium mb-2">Row Level Security</h4>
                <div id="rls-status" class="flex items-center text-yellow-500">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  <span>Status unknown</span>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-700 p-4 rounded-lg">
                  <h5 class="font-medium mb-2">Groups Table</h5>
                  <ul id="groups-policies" class="text-sm text-gray-300 space-y-2">
                    <li class="flex items-center">
                      <span class="inline-block w-4 h-4 mr-2 bg-gray-600 rounded-full animate-pulse"></span>
                      Checking policies...
                    </li>
                  </ul>
                </div>
                
                <div class="bg-gray-700 p-4 rounded-lg">
                  <h5 class="font-medium mb-2">Events Table</h5>
                  <ul id="events-policies" class="text-sm text-gray-300 space-y-2">
                    <li class="flex items-center">
                      <span class="inline-block w-4 h-4 mr-2 bg-gray-600 rounded-full animate-pulse"></span>
                      Checking policies...
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Events List View -->
            <div id="events-view" class="hidden">
              <div class="mb-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold">Events Management</h2>
                <button id="add-event-button" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center">
                  <i class="fas fa-plus mr-2"></i>
                  <span>Add Event</span>
                </button>
              </div>
              
              <!-- Filters and Search -->
              <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <!-- Search -->
                  <div class="col-span-1 md:col-span-2">
                    <label for="search" class="block text-sm font-medium text-gray-400 mb-1">Search</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-500"></i>
                      </div>
                      <input id="event-search" type="text" class="bg-gray-700 border-gray-600 text-white w-full pl-10 pr-4 py-2 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                  </div>
                  
                  <!-- Group Filter -->
                  <div>
                    <label for="group-filter" class="block text-sm font-medium text-gray-400 mb-1">Group</label>
                    <select id="group-filter" class="bg-gray-700 border-gray-600 text-white w-full py-2 px-3 rounded-md focus:ring-blue-500 focus:border-blue-500">
                      <option value="">All Groups</option>
                      <!-- Groups will be populated here -->
                    </select>
                  </div>
                  
                  <!-- Featured Filter -->
                  <div>
                    <label for="featured-filter" class="block text-sm font-medium text-gray-400 mb-1">Status</label>
                    <select id="featured-filter" class="bg-gray-700 border-gray-600 text-white w-full py-2 px-3 rounded-md focus:ring-blue-500 focus:border-blue-500">
                      <option value="">All Events</option>
                      <option value="true">Featured Only</option>
                      <option value="false">Not Featured</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Events Table -->
              <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                      <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" data-sort="title">
                          <div class="flex items-center">
                            <span>Event Name</span>
                            <span class="ml-1"><i class="fas fa-sort text-gray-500"></i></span>
                          </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" data-sort="date">
                          <div class="flex items-center">
                            <span>Date/Time</span>
                            <span class="ml-1"><i class="fas fa-sort text-gray-500"></i></span>
                          </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" data-sort="group">
                          <div class="flex items-center">
                            <span>Group</span>
                            <span class="ml-1"><i class="fas fa-sort text-gray-500"></i></span>
                          </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer" data-sort="featured">
                          <div class="flex items-center">
                            <span>Featured</span>
                            <span class="ml-1"><i class="fas fa-sort text-gray-500"></i></span>
                          </div>
                        </th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="events-table" class="bg-gray-800 divide-y divide-gray-700">
                      <tr class="animate-pulse">
                        <td colspan="5" class="px-6 py-4 text-center text-gray-400">Loading events...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Pagination -->
                <div class="bg-gray-700 px-4 py-3 flex items-center justify-between">
                  <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                      <p class="text-sm text-gray-400">
                        Showing <span id="page-start">-</span> to <span id="page-end">-</span> of <span id="total-events-count">-</span> events
                      </p>
                    </div>
                    <div>
                      <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-600 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                          <span class="sr-only">Previous</span>
                          <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="pagination-numbers" class="relative inline-flex items-center px-4 py-2 border border-gray-600 bg-gray-800 text-sm font-medium text-gray-400">
                          Page <span id="current-page">1</span>
                        </span>
                        <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-600 bg-gray-800 text-sm font-medium text-gray-400 hover:bg-gray-700">
                          <span class="sr-only">Next</span>
                          <i class="fas fa-chevron-right"></i>
                        </button>
                      </nav>
                    </div>
                  </div>
                </div>
              </div>
            </div>
              
              <!-- Recent Events Section -->
              <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold">Recent Events</h3>
                  <a href="#" id="view-all-events" class="text-blue-400 hover:text-blue-300 text-sm">View all</a>
                </div>
                
                <div class="bg-gray-800 rounded-lg overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                      <thead class="bg-gray-700">
                        <tr>
                          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Event Name</th>
                          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Group</th>
                          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="recent-events-table" class="bg-gray-800 divide-y divide-gray-700">
                        <tr class="animate-pulse">
                          <td colspan="5" class="px-6 py-4 text-center text-gray-400">Loading events...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <!-- Security Status Section -->
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold">Security Status</h3>
                  <a href="./setup-rls-policies.html" class="text-blue-400 hover:text-blue-300 text-sm">Manage</a>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-6">
                  <div class="mb-6">
                    <h4 class="text-lg font-medium mb-2">Row Level Security</h4>
                    <div id="rls-status" class="flex items-center text-yellow-500">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      <span>Status unknown</span>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700 p-4 rounded-lg">
                      <h5 class="font-medium mb-2">Groups Table</h5>
                      <ul id="groups-policies" class="text-sm text-gray-300 space-y-2">
                        <li class="flex items-center">
                          <span class="inline-block w-4 h-4 mr-2 bg-gray-600 rounded-full animate-pulse"></span>
                          Checking policies...
                        </li>
                      </ul>
                    </div>
                    
                    <div class="bg-gray-700 p-4 rounded-lg">
                      <h5 class="font-medium mb-2">Events Table</h5>
                      <ul id="events-policies" class="text-sm text-gray-300 space-y-2">
                        <li class="flex items-center">
                          <span class="inline-block w-4 h-4 mr-2 bg-gray-600 rounded-full animate-pulse"></span>
                          Checking policies...
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
          <div class="absolute inset-0 bg-black bg-opacity-50"></div>
          <div class="relative bg-gray-800 rounded-lg max-w-md w-full p-6">
            <div class="text-center mb-4">
              <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
              <h3 class="text-xl font-medium">Confirm Delete</h3>
              <p class="text-gray-400 mt-2">Are you sure you want to delete this event? This action cannot be undone.</p>
            </div>
            <div class="flex items-center justify-center space-x-4 mt-6">
              <button id="delete-cancel" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-md">
                Cancel
              </button>
              <button id="delete-confirm" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md">
                Delete
              </button>
            </div>
          </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
          <div class="absolute inset-0 bg-black bg-opacity-50"></div>
          <div class="relative bg-gray-800 rounded-lg max-w-md w-full p-6">
            <div class="text-center mb-4">
              <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
              <h3 class="text-xl font-medium">Confirm Delete</h3>
              <p class="text-gray-400 mt-2">Are you sure you want to delete this event? This action cannot be undone.</p>
            </div>
            <div class="flex items-center justify-center space-x-4 mt-6">
              <button id="delete-cancel" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-md">
                Cancel
              </button>
              <button id="delete-confirm" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md">
                Delete
              </button>
            </div>
          </div>
        </div>
        
        <!-- Not Authenticated Message -->
        <div id="not-authenticated" class="hidden flex flex-col items-center justify-center h-full text-center p-8">
          <div class="bg-red-500/20 p-6 rounded-lg mb-6 inline-block">
            <i class="fas fa-lock text-red-500 text-5xl"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2">Authentication Required</h2>
          <p class="text-gray-400 mb-6 max-w-md">You need to sign in to access the admin dashboard.</p>
          <a href="./auth/login.html" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out">
            Sign In
          </a>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Elements
      const loadingView = document.getElementById('loading');
      const contentView = document.getElementById('content');
      const notAuthenticatedView = document.getElementById('not-authenticated');
      
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileSidebar = document.getElementById('mobile-sidebar');
      const mobileMenuClose = document.getElementById('mobile-menu-close');
      
      const sidebarUserInitials = document.getElementById('sidebar-user-initials');
      const sidebarUserEmail = document.getElementById('sidebar-user-email');
      const sidebarLogoutButton = document.getElementById('sidebar-logout-button');
      
      const mobileUserInitials = document.getElementById('mobile-user-initials');
      const mobileUserEmail = document.getElementById('mobile-user-email');
      const mobileLogoutButton = document.getElementById('mobile-logout-button');
      
      const totalEventsElement = document.getElementById('total-events');
      const totalGroupsElement = document.getElementById('total-groups');
      const upcomingEventsElement = document.getElementById('upcoming-events');
      const recentEventsTable = document.getElementById('recent-events-table');
      
      const rlsStatusElement = document.getElementById('rls-status');
      const groupsPoliciesElement = document.getElementById('groups-policies');
      const eventsPoliciesElement = document.getElementById('events-policies');
      
      // Toggle mobile menu
      if (mobileMenuToggle && mobileSidebar && mobileMenuClose) {
        mobileMenuToggle.addEventListener('click', function() {
          mobileSidebar.classList.remove('hidden');
        });
        
        mobileMenuClose.addEventListener('click', function() {
          mobileSidebar.classList.add('hidden');
        });
        
        // Close when clicking outside
        mobileSidebar.addEventListener('click', function(e) {
          if (e.target === mobileSidebar) {
            mobileSidebar.classList.add('hidden');
          }
        });
      }
      
      // Check authentication
      async function checkAuth() {
        if (!window.Auth) {
          console.error('Auth module not found');
          showNotAuthenticated();
          return false;
        }
        
        try {
          // Refresh auth state to ensure it's current
          await window.Auth.refresh();
          
          if (window.Auth.isAuthenticated()) {
            // User is authenticated
            updateUserInfo();
            return true;
          } else {
            // User is not authenticated
            showNotAuthenticated();
            return false;
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          showNotAuthenticated();
          return false;
        }
      }
      
      // Update user info in UI
      function updateUserInfo() {
        const user = window.Auth.getCurrentUser();
        
        if (user) {
          // Get initials for avatar
          const initials = user.email
            .split('@')[0]
            .split('.')
            .map(part => part.charAt(0).toUpperCase())
            .join('')
            .substring(0, 2);
          
          // Update sidebar user info
          if (sidebarUserInitials) sidebarUserInitials.textContent = initials;
          if (sidebarUserEmail) sidebarUserEmail.textContent = user.email;
          
          // Update mobile user info
          if (mobileUserInitials) mobileUserInitials.textContent = initials;
          if (mobileUserEmail) mobileUserEmail.textContent = user.email;
        }
      }
      
      // Show not authenticated view
      function showNotAuthenticated() {
        if (loadingView) loadingView.classList.add('hidden');
        if (contentView) contentView.classList.add('hidden');
        if (notAuthenticatedView) notAuthenticatedView.classList.remove('hidden');
      }
      
      // Handle logout
      async function handleLogout() {
        try {
          await window.Auth.signOut();
          window.location.href = './auth/login.html';
        } catch (error) {
          console.error('Logout failed:', error);
          alert('Failed to sign out: ' + error.message);
        }
      }
      
      // Add logout handlers
      if (sidebarLogoutButton) {
        sidebarLogoutButton.addEventListener('click', handleLogout);
      }
      
      if (mobileLogoutButton) {
        mobileLogoutButton.addEventListener('click', handleLogout);
      }
      
      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Check connection to Supabase
          const connectionStatus = window.getConnectionStatus();
          
          if (!connectionStatus.isConnected) {
            await window.checkConnection();
          }
          
          // Load counts
          await Promise.all([
            loadEventCount(),
            loadGroupCount(),
            loadUpcomingEventCount(),
            loadRecentEvents(),
            checkRLSPolicies()
          ]);
          
          // Show content
          if (loadingView) loadingView.classList.add('hidden');
          if (contentView) contentView.classList.remove('hidden');
        } catch (error) {
          console.error('Error loading dashboard data:', error);
          
          // Show error in UI
          if (loadingView) {
            loadingView.innerHTML = `
              <div class="text-red-500 mb-4">
                <i class="fas fa-exclamation-circle text-4xl"></i>
              </div>
              <p class="text-lg font-medium mb-2">Failed to load dashboard data</p>
              <p class="text-gray-400 mb-4">${error.message || 'Unknown error'}</p>
              <button id="retry-button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                Retry
              </button>
            `;
            
            document.getElementById('retry-button')?.addEventListener('click', loadDashboardData);
          }
        }
      }
      
      // Load total event count
      async function loadEventCount() {
        try {
          const { count, error } = await window.supabase
            .from('events')
            .select('*', { count: 'exact', head: true });
          
          if (error) throw error;
          
          if (totalEventsElement) {
            totalEventsElement.textContent = count;
          }
        } catch (error) {
          console.error('Error loading event count:', error);
          if (totalEventsElement) {
            totalEventsElement.textContent = 'Error';
            totalEventsElement.classList.add('text-red-500');
          }
        }
      }
      
      // Load group count
      async function loadGroupCount() {
        try {
          const { count, error } = await window.supabase
            .from('groups')
            .select('*', { count: 'exact', head: true });
          
          if (error) throw error;
          
          if (totalGroupsElement) {
            totalGroupsElement.textContent = count;
          }
        } catch (error) {
          console.error('Error loading group count:', error);
          if (totalGroupsElement) {
            totalGroupsElement.textContent = 'Error';
            totalGroupsElement.classList.add('text-red-500');
          }
        }
      }
      
      // Load upcoming event count
      async function loadUpcomingEventCount() {
        try {
          const today = new Date();
          const thirtyDaysFromNow = new Date();
          thirtyDaysFromNow.setDate(today.getDate() + 30);
          
          const todayStr = today.toISOString().split('T')[0];
          const futureStr = thirtyDaysFromNow.toISOString().split('T')[0];
          
          // First try with event_date field
          let result = await window.supabase
            .from('events')
            .select('*', { count: 'exact', head: true })
            .gte('event_date', todayStr)
            .lte('event_date', futureStr);
          
          // If that fails, try with date field instead
          if (result.error && result.error.message.includes('column "event_date" does not exist')) {
            console.log('Retrying with "date" field instead of "event_date"');
            result = await window.supabase
              .from('events')
              .select('*', { count: 'exact', head: true })
              .gte('date', todayStr)
              .lte('date', futureStr);
          }
          
          if (result.error) throw result.error;
          
          if (upcomingEventsElement) {
            upcomingEventsElement.textContent = result.count;
          }
        } catch (error) {
          console.error('Error loading upcoming event count:', error);
          if (upcomingEventsElement) {
            upcomingEventsElement.textContent = 'Error';
            upcomingEventsElement.classList.add('text-red-500');
          }
        }
      }
      
      // Load recent events
      async function loadRecentEvents() {
        try {
          const { data, error } = await window.supabase
            .from('events')
            .select('*, groups(name)')
            .order('created_at', { ascending: false })
            .limit(5);
          
          if (error) throw error;
          
          if (recentEventsTable) {
            if (data.length === 0) {
              recentEventsTable.innerHTML = `
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-400">No events found</td>
                </tr>
              `;
            } else {
              // Log retrieved data to debug date fields
              console.log('Recent events data:', data);
              
              recentEventsTable.innerHTML = data.map(event => {
                const today = new Date();
                
                // Fix date field handling - check both possible field names
                // The database might be using either 'date' or 'event_date'
                const dateValue = event.date || event.event_date;
                console.log(`Event ${event.id} date value:`, dateValue);
                
                // Safe date parsing with validation
                let eventDate = null;
                let formattedDate = 'Invalid date';
                
                try {
                  if (dateValue) {
                    eventDate = new Date(dateValue);
                    if (!isNaN(eventDate.getTime())) {
                      formattedDate = eventDate.toLocaleDateString();
                    } else {
                      console.error(`Invalid date format for event ${event.id}:`, dateValue);
                    }
                  } else {
                    console.error(`Missing date for event ${event.id}`);
                  }
                } catch (error) {
                  console.error(`Error parsing date for event ${event.id}:`, error);
                }
                
                // Determine event status based on date
                let status = '<span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-gray-300">Unknown</span>';
                
                if (eventDate) {
                  if (eventDate < today) {
                    status = '<span class="px-2 py-1 text-xs rounded-full bg-gray-600 text-gray-300">Past</span>';
                  } else if (eventDate.toDateString() === today.toDateString()) {
                    status = '<span class="px-2 py-1 text-xs rounded-full bg-green-600/20 text-green-400">Today</span>';
                  } else {
                    status = '<span class="px-2 py-1 text-xs rounded-full bg-blue-600/20 text-blue-400">Upcoming</span>';
                  }
                }
                
                return `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${event.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${event.groups?.name || 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                      <a href="#" class="text-blue-400 hover:text-blue-300 mr-3">Edit</a>
                      <a href="#" class="text-red-400 hover:text-red-300">Delete</a>
                    </td>
                  </tr>
                `;
              }).join('');
            }
          }
        } catch (error) {
          console.error('Error loading recent events:', error);
          if (recentEventsTable) {
            recentEventsTable.innerHTML = `
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-red-400">
                  <i class="fas fa-exclamation-circle mr-2"></i>
                  Failed to load events: ${error.message || 'Unknown error'}
                </td>
              </tr>
            `;
          }
        }
      }
      
      // Check RLS policies
      async function checkRLSPolicies() {
        try {
          console.log('Starting RLS policy check...');
          
          // Get RLS policies for groups table
          const groupsResult = await window.supabase
            .rpc('get_policies', { table_name: 'groups' });
          
          console.log('Groups policies result:', groupsResult);
          
          if (groupsResult.error) {
            console.error('Groups policies error:', groupsResult.error);
            throw groupsResult.error;
          }
          
          // Get RLS policies for events table
          const eventsResult = await window.supabase
            .rpc('get_policies', { table_name: 'events' });
          
          console.log('Events policies result:', eventsResult);
          
          if (eventsResult.error) {
            console.error('Events policies error:', eventsResult.error);
            throw eventsResult.error;
          }
          
          const groupsPolicies = groupsResult.data;
          const eventsPolicies = eventsResult.data;
          
          // Update groups policies display
          if (groupsPoliciesElement) {
            if (groupsPolicies && groupsPolicies.length > 0) {
              groupsPoliciesElement.innerHTML = groupsPolicies.map(policy => {
                const isSecure = policy.command.includes("auth.role() = 'authenticated'");
                const icon = isSecure 
                  ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>'
                  : '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
                
                return `
                  <li class="flex items-start">
                    ${icon}
                    <div>
                      <div class="font-medium">${policy.name}</div>
                      <div class="text-xs text-gray-400">${policy.operation} operation</div>
                    </div>
                  </li>
                `;
              }).join('');
            } else {
              groupsPoliciesElement.innerHTML = `
                <li class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                  No policies found
                </li>
              `;
            }
          }
          
          // Update events policies display
          if (eventsPoliciesElement) {
            if (eventsPolicies && eventsPolicies.length > 0) {
              eventsPoliciesElement.innerHTML = eventsPolicies.map(policy => {
                const isSecure = policy.command.includes("auth.role() = 'authenticated'");
                const icon = isSecure 
                  ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>'
                  : '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
                
                return `
                  <li class="flex items-start">
                    ${icon}
                    <div>
                      <div class="font-medium">${policy.name}</div>
                      <div class="text-xs text-gray-400">${policy.operation} operation</div>
                    </div>
                  </li>
                `;
              }).join('');
            } else {
              eventsPoliciesElement.innerHTML = `
                <li class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                  No policies found
                </li>
              `;
            }
          }
          
          // Update overall RLS status
          if (rlsStatusElement) {
            let allPolicies = [...(groupsPolicies || []), ...(eventsPolicies || [])];
            let writeOperations = allPolicies.filter(p => 
              p.operation === 'INSERT' || 
              p.operation === 'UPDATE' || 
              p.operation === 'DELETE'
            );
            
            let secureWriteOperations = writeOperations.filter(p => 
              p.command.includes("auth.role() = 'authenticated'")
            );
            
            if (writeOperations.length === 0) {
              rlsStatusElement.className = 'flex items-center text-yellow-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>No write operation policies found</span>
              `;
            } else if (secureWriteOperations.length === writeOperations.length) {
              rlsStatusElement.className = 'flex items-center text-green-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-shield-alt mr-2"></i>
                <span>Write operations secured (authenticated users only)</span>
              `;
            } else {
              rlsStatusElement.className = 'flex items-center text-red-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>Insecure policies detected</span>
              `;
            }
          }
        } catch (error) {
          console.error('Error checking RLS policies:', error);
          
          // Try fallback method if RPC fails
          try {
            console.log('Attempting fallback method to check policies...');
            await checkPoliciesFallback();
            return;
          } catch (fallbackError) {
            console.error('Fallback method also failed:', fallbackError);
            
            if (groupsPoliciesElement) {
              groupsPoliciesElement.innerHTML = `
                <li class="flex items-center">
                  <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                  Error checking policies
                </li>
                <li class="text-xs text-gray-400 mt-1">
                  ${error.message || 'Unknown error'}
                </li>
              `;
            }
            
            if (eventsPoliciesElement) {
              eventsPoliciesElement.innerHTML = `
                <li class="flex items-center">
                  <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                  Error checking policies
                </li>
                <li class="text-xs text-gray-400 mt-1">
                  ${error.message || 'Unknown error'}
                </li>
              `;
            }
            
            if (rlsStatusElement) {
              rlsStatusElement.className = 'flex items-center text-red-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>Error checking policies</span>
              `;
            }
          }
        }
      }
      
      /**
       * Fallback method to check RLS policies when RPC fails
       * Uses direct table operations to infer policy settings
       */
      async function checkPoliciesFallback() {
        console.log('Executing fallback policy check...');
        
        // Simulated policy data structure
        let groupsPolicies = [];
        let eventsPolicies = [];
        
        // Test read access for groups
        const groupsReadResult = await window.supabase
          .from('groups')
          .select('id')
          .limit(1);
          
        console.log('Groups read test:', groupsReadResult);
        
        if (!groupsReadResult.error) {
          groupsPolicies.push({
            name: 'Read access policy',
            operation: 'SELECT',
            command: 'SELECT policy detected (inferred)'
          });
        }
        
        // Test read access for events
        const eventsReadResult = await window.supabase
          .from('events')
          .select('id')
          .limit(1);
          
        console.log('Events read test:', eventsReadResult);
        
        if (!eventsReadResult.error) {
          eventsPolicies.push({
            name: 'Read access policy',
            operation: 'SELECT',
            command: 'SELECT policy detected (inferred)'
          });
        }
        
        // Now attempt an insert to check write access (will be rolled back)
        // Only perform this if we're authenticated
        if (window.Auth && window.Auth.isAuthenticated()) {
          // Test insert access for groups with transaction that we'll roll back
          try {
            console.log('Testing groups write access...');
            const { data, error } = await window.supabase.rpc('check_write_access', {
              table_name: 'groups'
            });
            
            console.log('Groups write test:', { data, error });
            
            if (!error) {
              groupsPolicies.push({
                name: 'Write access policy',
                operation: 'INSERT',
                command: "INSERT policy detected (auth.role() = 'authenticated')"
              });
            }
          } catch (error) {
            console.log('Groups write test error:', error);
          }
          
          // Test insert access for events
          try {
            console.log('Testing events write access...');
            const { data, error } = await window.supabase.rpc('check_write_access', {
              table_name: 'events'
            });
            
            console.log('Events write test:', { data, error });
            
            if (!error) {
              eventsPolicies.push({
                name: 'Write access policy',
                operation: 'INSERT',
                command: "INSERT policy detected (auth.role() = 'authenticated')"
              });
            }
          } catch (error) {
            console.log('Events write test error:', error);
          }
        }
        
        // Update groups policies display
        if (groupsPoliciesElement) {
          if (groupsPolicies.length > 0) {
            groupsPoliciesElement.innerHTML = groupsPolicies.map(policy => {
              const isSecure = policy.operation === 'SELECT' ||
                               policy.command.includes("authenticated");
              const icon = isSecure
                ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>'
                : '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
              
              return `
                <li class="flex items-start">
                  ${icon}
                  <div>
                    <div class="font-medium">${policy.name}</div>
                    <div class="text-xs text-gray-400">${policy.operation} operation</div>
                  </div>
                </li>
              `;
            }).join('');
          } else {
            groupsPoliciesElement.innerHTML = `
              <li class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                Could not detect policies
              </li>
            `;
          }
        }
        
        // Update events policies display
        if (eventsPoliciesElement) {
          if (eventsPolicies.length > 0) {
            eventsPoliciesElement.innerHTML = eventsPolicies.map(policy => {
              const isSecure = policy.operation === 'SELECT' ||
                               policy.command.includes("authenticated");
              const icon = isSecure
                ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>'
                : '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
              
              return `
                <li class="flex items-start">
                  ${icon}
                  <div>
                    <div class="font-medium">${policy.name}</div>
                    <div class="text-xs text-gray-400">${policy.operation} operation</div>
                  </div>
                </li>
              `;
            }).join('');
          } else {
            eventsPoliciesElement.innerHTML = `
              <li class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                Could not detect policies
              </li>
            `;
          }
        }
        
        // Update overall RLS status
        if (rlsStatusElement) {
          if (groupsPolicies.length > 0 || eventsPolicies.length > 0) {
            const hasReadPolicies = groupsPolicies.some(p => p.operation === 'SELECT') ||
                                   eventsPolicies.some(p => p.operation === 'SELECT');
            const hasWritePolicies = groupsPolicies.some(p => p.operation === 'INSERT') ||
                                    eventsPolicies.some(p => p.operation === 'INSERT');
            
            if (hasReadPolicies && hasWritePolicies) {
              rlsStatusElement.className = 'flex items-center text-green-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-shield-alt mr-2"></i>
                <span>Security policies detected (inferred)</span>
              `;
            } else if (hasReadPolicies) {
              rlsStatusElement.className = 'flex items-center text-yellow-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>Read policies only (write policies unknown)</span>
                <a href="#" onclick="showSetupInstructions()" class="ml-2 text-xs text-blue-400 hover:text-blue-300">
                  <i class="fas fa-info-circle"></i> Fix
                </a>
              `;
            } else {
              rlsStatusElement.className = 'flex items-center text-red-500';
              rlsStatusElement.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>Policy status undetermined</span>
              `;
            }
          } else {
            rlsStatusElement.className = 'flex items-center text-yellow-500';
            rlsStatusElement.innerHTML = `
              <i class="fas fa-exclamation-triangle mr-2"></i>
              <span>Status unknown</span>
            `;
          }
        }
      }
      
      /**
       * Display setup instructions modal to help fix policy checking
       */
      function showSetupInstructions() {
        // Create modal if it doesn't exist
        if (!document.getElementById('setup-instructions-modal')) {
          const modal = document.createElement('div');
          modal.id = 'setup-instructions-modal';
          modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
          modal.innerHTML = `
            <div class="absolute inset-0 bg-black bg-opacity-50"></div>
            <div class="relative bg-gray-800 rounded-lg max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-medium">Setup Instructions</h3>
                <button id="close-instructions" class="text-gray-400 hover:text-white">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="prose prose-invert prose-sm">
                <p>To fully enable the Security Status checker, you need to set up two database functions in Supabase:</p>
                <ol>
                  <li>
                    <p><strong>get_policies</strong> - Retrieves policy information for tables</p>
                  </li>
                  <li>
                    <p><strong>check_write_access</strong> - Tests write access without modifying data</p>
                  </li>
                </ol>
                <p>Complete setup instructions have been provided in the file:</p>
                <pre class="bg-gray-700 p-2 rounded"><code>policy-checker-setup-instructions.md</code></pre>
                <p>After applying these functions, reload the admin dashboard to get complete security status information.</p>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          // Add close handler
          document.getElementById('close-instructions').addEventListener('click', function() {
            document.getElementById('setup-instructions-modal').remove();
          });
        } else {
          // Show the existing modal
          document.getElementById('setup-instructions-modal').classList.remove('hidden');
        }
      }
      
      // Initialize
      const isAuthenticated = await checkAuth();
      
      if (isAuthenticated) {
        loadDashboardData();
      }
      
      // Listen for auth state changes
      if (window.Auth) {
        window.Auth.addEventListener('onAuthStateChange', (state) => {
          if (!state.user) {
            // User signed out, redirect to login
            window.location.href = './auth/login.html';
          }
        });
      }
    });
  </script>
</body>
</html>